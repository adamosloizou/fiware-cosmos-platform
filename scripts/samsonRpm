#
# Checking command line options
#
if [ "$#" != 2 ]
then
	echo 'samsonRpm: Bad parameters'
	echo 'Usage: samsonRpm <Version (e.g. 0.5)> <Release (e.g. 3)>'
	exit 1
fi



#
# Using command line options
#
version=$1
release=$2



#
# Help variables
#
vr=$version.$release
tarfile=samson-$version.tar.gz
specfile=samson-$vr.spec
rdir=samson-$version



#
# Preparing HOME directory for RPM
#
echo "%_topdir $HOME/rpm" > ~/.rpmmacros
echo "%_unpackaged_files_terminate_build      0" >> ~/.rpmmacros

if [ ! -d $HOME/rpm ];
then
    mkdir -p $HOME/rpm/{SOURCES,SPECS,BUILD,SRPMS,BUILDROOT}
fi




#
# Creating link for 'compiled stuff' ...
#
arch=$(uname -p)
ln -s $HOME/rpm/BUILD/samson-$version $HOME/rpm/BUILDROOT/samson-$version-$release.$arch



#
# Creating the SPEC file
#
echo "Summary:   Samson Map Reduce Platform"                  > $HOME/rpm/SPECS/$specfile
echo "Name:      samson"                                     >> $HOME/rpm/SPECS/$specfile
echo "Version:   " $version                                  >> $HOME/rpm/SPECS/$specfile
echo "Release:   " $release                                  >> $HOME/rpm/SPECS/$specfile
echo "License:   commercial"                                 >> $HOME/rpm/SPECS/$specfile
echo "Group:     Applications/Engineering"                   >> $HOME/rpm/SPECS/$specfile
echo "Source:    http://www.tid.es/samson-$version.tar.gz"   >> $HOME/rpm/SPECS/$specfile
echo "BuildRoot: /var/tmp/%{name}-buildroot"                 >> $HOME/rpm/SPECS/$specfile
echo                                                         >> $HOME/rpm/SPECS/$specfile
echo "%description"                                          >> $HOME/rpm/SPECS/$specfile
echo "The Samson Map Reduce Platform ..."                    >> $HOME/rpm/SPECS/$specfile
echo                                                         >> $HOME/rpm/SPECS/$specfile
echo "%prep"                                                 >> $HOME/rpm/SPECS/$specfile
echo "%setup"                                                >> $HOME/rpm/SPECS/$specfile
echo                                                         >> $HOME/rpm/SPECS/$specfile
#echo "%install"                                              >> $HOME/rpm/SPECS/$specfile
echo                                                         >> $HOME/rpm/SPECS/$specfile
echo "%clean"                                                >> $HOME/rpm/SPECS/$specfile
echo                                                         >> $HOME/rpm/SPECS/$specfile
echo "%files"                                                >> $HOME/rpm/SPECS/$specfile
echo '/usr/local/bin/samson*'                                >> $HOME/rpm/SPECS/$specfile
echo '/usr/local/bin/delilah'                                >> $HOME/rpm/SPECS/$specfile
#echo '/usr/local/man/man1/*'                                 >> $HOME/rpm/SPECS/$specfile
#echo '/usr/local/man/man3/*'                                 >> $HOME/rpm/SPECS/$specfile
echo '/opt/samson/etc/setup.txt'                             >> $HOME/rpm/SPECS/$specfile
echo "%changelog"                                            >> $HOME/rpm/SPECS/$specfile
echo                                                         >> $HOME/rpm/SPECS/$specfile



#
# Preparing the directory with the RPM contents
#
rm -rf ~/$rdir
mkdir -p ~/$rdir/usr/local
mkdir ~/$rdir/usr/local/bin
mkdir -p ~/$rdir/opt/samson/etc
mkdir ~/$rdir/usr/local/man
mkdir ~/$rdir/usr/local/man/man1
mkdir ~/$rdir/usr/local/man/man3
cp BUILD_RELEASE/apps/samsonCat/samsonCat              ~/$rdir/usr/local/bin
cp BUILD_RELEASE/apps/samsonController/samsonController       ~/$rdir/usr/local/bin
cp BUILD_RELEASE/apps/samsonData/samsonData             ~/$rdir/usr/local/bin
cp BUILD_RELEASE/apps/samsonLocal/samsonLocal            ~/$rdir/usr/local/bin
cp BUILD_RELEASE/apps/samsonModuleParser/samsonModuleParser     ~/$rdir/usr/local/bin
cp BUILD_RELEASE/apps/samsonSetup/samsonSetup            ~/$rdir/usr/local/bin
cp BUILD_RELEASE/apps/samsonSpawner/samsonSpawner          ~/$rdir/usr/local/bin
cp BUILD_RELEASE/apps/samsonWorker/samsonWorker           ~/$rdir/usr/local/bin
cp BUILD_RELEASE/apps/delilah/delilah                ~/$rdir/usr/local/bin
cp etc/setup.txt             ~/$rdir/opt/samson/etc/
#cp -R /usr/local/man/                    ~/$rdir/usr/local/



#
# Create the tar file
#
cd
tar cvfz $tarfile $rdir
mv $tarfile ~/rpm/SOURCES
cd -



#
# And finally, create the RPM
#
cd ~/rpm/SPECS
rpmbuild -bb $specfile
cd -
mkdir -p package/rpm
mv ~/rpm/RPMS/$arch/samson-$version-$release.$arch.rpm package/rpm/
