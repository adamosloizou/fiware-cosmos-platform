/*
 * Telefónica Digital - Product Development and Innovation
 *
 * THIS CODE AND INFORMATION ARE PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND,
 * EITHER EXPRESSED OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE IMPLIED
 * WARRANTIES OF MERCHANTABILITY AND/OR FITNESS FOR A PARTICULAR PURPOSE.
 *
 * Copyright (c) Telefónica Investigación y Desarrollo S.A.U.
 * All rights reserved.
 */

/**
 File autogenerated with samsonModuleParser. Please, edit to complete this operation
*/

#ifndef _H_SAMSON_urlbenchmark_parse_servers
#define _H_SAMSON_urlbenchmark_parse_servers


#include <samson/module/samson.h>

/***************************************************
parser parse_servers
{
	out system.String system.UInt   # ServerName - Category

	helpLine "Parse input text with server classification"
}
***************************************************/

namespace samson{
namespace urlbenchmark{


	class parse_servers : public samson::Parser
	{

	public:


		void run( char *data , size_t length , samson::KVWriter *writer )
		{
			samson::system::String serverName;
			samson::system::UInt categ;

			//OLM_M(("Parsing length:%d", length));

			size_t offset = 0;
			size_t line_begin = 0;

			while( offset < length )
			{

				if( data[offset] == '\n' || data[offset] == '\0' )
				{
					data[offset] = '\0';

					char *p_line = data+line_begin;
	            	char *p_server;
	            	char *p_cat;


	            	p_server = p_line;
					if (((p_cat = strchr(p_line, '|')) != NULL) || ((p_cat = strchr(p_line, ' ')) != NULL))
					{
						*p_cat = '\0';
						p_cat++;
					}
					else
					{
						p_cat = p_line;
					}

					if (!strncmp(p_cat, "cat_", strlen("cat_")))
					{
						p_cat += strlen("cat_");
					}




	            	serverName.value = p_server;
	            	categ.value = atoll(p_cat);

	                writer->emit( 0 , &serverName, &categ);

					line_begin = offset+1;
				}
				++offset;
			}
			// Goyo. Mientras no tenga claro cómo se trocea el texto de entrada, mejor no procesar la última línea
			//OLM_T(LMT_User01, ("Last Detected line with offset:%d, length:%d, line_begin:%d, data[length-1]:%d", offset, length, line_begin, data[length-1]));
			//parseLines(data+line_begin , writer);
			//OLM_T(LMT_User01, ("Returned from parseLines"));


		}


	};


} // end of namespace samson
} // end of namespace urlbenchmark

#endif
