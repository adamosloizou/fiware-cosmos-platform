Module sna
{

	title	"Social Network Analysis from graphs"
	author 	"Andreu Urruela (andreu@tid.es)"
	version "2.4.0"

	set	 sna.num_cdrs_for_strong_connection			4
	set	 sna.history_graph_importance				0.7
	set	 sna.weight_link_to_die					85
	set	 sna.number_spikes_to_punctual_relationship		1
	set	 sna.threshold_to_fuse_cliques			 	0.7
	set	 sna.threshold_to_add_associated_nodes		 	0.6
	set	 sna.cliques_penalization_missing_link		 	1.0
	set	 sna.max_strong_connections_per_node			 50
	set	 sna.max_connections_per_node				400
	set	 sna.community_fusion_min_overlaping			 0.8
	set	 sna.community_fusion_new_threshold			 0.5
	set	 sna.community_max_community_links		 	 10
	set	 sna.min_weighted_link_weight				150

	help
	{

	}


}

# ---------------------------------------------------------------------------
# datas for SNA
# ---------------------------------------------------------------------------


data Clique
{
	 vector system.UInt nodes;
}

data Clique_Link
{
	 sna.Clique clique;
	 system.Float weight;	
}

data Clique_Node
{
	 sna.Clique clique;
	 vector sna.Clique_Link links;
}

data Vector_Clique_Node
{ 
	 vector sna.Clique_Node items;
}

data Clique2
{
	 sna.Clique clique_1;
	 sna.Clique clique_2;
}

# Vectors of nodes and cliques

data Vector_Node
{
	vector graph.Node items;
}

data Vector_Clique 
{ 
	vector sna.Clique items; 
}

# ---------------------------------------------------------------------------
# Cliques computation
# ---------------------------------------------------------------------------


# Computing cliques from a graph

script compute_cliques
{
	in	system.UInt graph.Node
	out	sna.Clique system.Void
	
	top

	code
	{
		sna.spread_nodes_to_strong_connections $1 $1.spread -create -clear;
		sna.compute_cliques_from_spread_graph $1.spread $2 -clear;
		rm $1.spread -f;
	}

	helpLine "Compute cliques from a graph"		
}

map spread_nodes_to_strong_connections
{
	in system.UInt	graph.Node
	out system.UInt	graph.Node

	helpLine	"First step to compute cliques from a graph."
	
	help
	{
		"First step to compute cliques from a graph."
		"Here, nodes are spread in the sense that for each input node in the graph, we emit N outputs where"
		"N is the number of strong connections"
		"Basically, we sent the node to all the strongly connected nodes"
		"For performance, a reduced version of the node (only strong connections) is sent"
	}
}

reduce compute_cliques_from_spread_graph
{
	in	system.UInt graph.Node
	out	sna.Clique system.Void
	
	helpLine	"Second step of the compute_cliques script"

	help
	{
		"Second step to compute cliques from a graph."
		"Here, we collect all the nodes that are connected to a particular node, and the cliques are computed"
	}
}

parserOut export_cliques
{
	in sna.Clique system.Void

	helpLine "Export cliques to txt files"
}
