# Some cleaning
echo "Starting word count stream test 100MB"
echo "Killing all previous processes..."
rm /opt/samson/config/samsonPlatformProcesses
samsonKiller
echo "Setting controller IP..."
CONTROLLER_IP="localhost";
export CONTROLLER_IP
echo "Controller:" $CONTROLLER_IP


# Running inside build/testing
if [ -n "${CONTROLLER_IP:+x}" ]; then
        echo "Environment variable CONTROLLER_IP defined to: " $CONTROLLER_IP > test_stream_100MB_stdout
        if [ $CONTROLLER_IP = "localhost" ]; then
#                if ! ps -C samsonSpawner  > /dev/null
#                then
                        echo "Launching samsonSpawner" >> test_stream_100MB_stdout
                        samsonSpawner -local >> test_stream_100MB_stdout
#                else
#                        echo "samsonSpawner already running" >> test_stream_100MB_stdout
#                fi
        fi

		echo "Removing previous data for testing..."
		delilah -f test_reset_commands.txt

	echo "Generating test data..."
	word_generator 10000000 | samsonPush -controller $CONTROLLER_IP  words -v
	

which delilah
        delilah -controller $CONTROLLER_IP -f test_stream_100MB_commands.txt >> test_stream_100MB_stdout
else
        echo "Environment variable CONTROLLER_IP not defined, using samsonLocal" > test_stream_100MB_stdout
        samsonLocal -working . -f test_stream_100MB_commands.txt >> test_stream_100MB_stdout
fi


#echo "Generating test


export LANG=C
echo "Saving and sorting the output into a file..."
samsonCat out_100MB | sort > out_100MB_md5.txt
echo "Making the MD5 file to compare"
md5sum out_100MB_md5.txt > test_stream_100MB_out.txt
#rm -rf out_100MB

#Compare the produced output with the expected output
diff  test_stream_100MB_out.txt test_stream_100MB_expected_out.txt >> test_stream_100MB_diff_result
if [ $? = 0 ]; then
        echo "TEST RESULT: OK"
	echo "exit 0" > test_stream_100MB_stdout
else
        echo "TEST RESULT: KO"
        echo "exit 1" > test_stream_100MB_stdout

fi
echo "Done"

