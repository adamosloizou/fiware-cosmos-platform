# Some cleaning
echo "Starting word count test"
rm /opt/samson/config/samsonPlatformProcesses
samsonKiller
echo "Setting controller IP"
CONTROLLER_IP="localhost";
export CONTROLLER_IP
echo $CONTROLLER_IP


# Running inside build/testing
/usr/local/bin/samsonLocal -working . -f test_1_complete_commands.txt >test_1_complete_stdout 2>test_1_complete_stderr
if [ -n "${CONTROLLER_IP:+x}" ]; then
        echo "Environment variable CONTROLLER_IP defined to: " $CONTROLLER_IP > test_1_complete_stdout
        if [ $CONTROLLER_IP = "localhost" ]; then
                if ! ps -C samsonSpawner  > /dev/null
                then
                        echo "Launching samsonSpawner" >> test_1_complete_stdout
                        samsonSpawner -local >> test_1_complete_stdout 
                else
                        echo "samsonSpawner already running" >> test_1_complete_stdout
                fi
              #  sleep 3
        fi
        /usr/local/bin/delilah -controller $CONTROLLER_IP -f test_1_complete_commands.txt >> test_1_complete_stdout 
else
        echo "Environment variable CONTROLLER_IP not defined, using samsonLocal" > test_1_complete_stdout
        /usr/local/bin/samsonLocal -working . -f test_1_complete_commands.txt >> test_1_complete_stdout 2> test_1_complete_stderr
fi

echo "Sorting and Saving Output File"
export LANG=C
samsonCat out | sort  > test_1_complete_out.txt
#rm -rf out

#Compare the produced output with the expected output
diff  test_1_complete_out.txt test_1_complete_expected_out.txt >> test_1_complete_diff_result
if [ $? == 0 ]; then
	echo "TEST RESULT: OK"
else
	echo "TEST RESULT: KO"
	exit 1

fi 
echo "Done"
