Module shop
{

	title	"shop  module"
	author 	"Andreu Urruela (andreu@tid.es)"
	version "0.1"
	
}

# ---------------------------------------------------------------------------
# datas
# ---------------------------------------------------------------------------

data Operation
{
        system.UInt user;
        system.UInt product;
        system.UInt operation;
}

data VectorProducts
{
        vector system.UInt products;
}

generator test_generator
{
        out system.UInt shop.Operation

        helpLine "Simple generator that generates shop.Operation operations"
}

generator test_generator_fixed
{
        out system.UInt shop.Operation

        helpLine "Simple generator that generates fixed shop.Operation operations (not random)"
}

parser parse_data_generated
{
		out system.UInt shop.Operation
		
		helpLine "Parser to read generated operations data"
}

map map_by_user
{
        in system.UInt shop.Operation
        out system.UInt system.UInt

        top

        helpLine "Map example; from input_data [UInt - Operation] emits key-values [UInt - UInt] with user-id and product-id"


}

reduce reduce_by_user
{
        in system.UInt system.UInt
        out system.UInt shop.VectorProducts

        top

        helpLine "Reduce example; from key-values groups the list of products by user"
}

reduce reduce_by_user_state
{
        in system.UInt system.UInt
        in system.UInt shop.VectorProducts
        out system.UInt shop.VectorProducts

        top

        helpLine "Reduce example; from key-values groups the list of products by user, working in streaming with a user state"
}

parserOut export_to_txt
{
        in system.UInt shop.VectorProducts

	helpLine "Export system.UInt shop.VectorProducts key-values in a standard format. Use shop.separator to custommize separator"
}

script test_1
{
	out txt txt
	
	helpLine "Test script"
	
	code
	{
		rm -f test_data_operations test_data_op_user  test_data_VectorProducts test_data_VectorProducts ;
		clear $1;
		shop.test_generator_fixed test_data_operations -clear -create;
		shop.map_by_user test_data_operations test_data_user_op -clear -create;
		shop.reduce_by_user test_data_user_op test_data_VectorProducts -clear -create;
		shop.export_to_txt test_data_VectorProducts $1 -clear -create;
		#rm -f test_data_operations test_data_op_user  test_data_VectorProducts test_data_VectorProducts;
	}
}
