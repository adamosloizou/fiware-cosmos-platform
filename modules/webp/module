
Module webp
{
	title	"Web Profiling"
	author	"Andreu Urruela & Gregorio Escalad"
	version "0.2"
}


data Category
{
	system.UInt id;
	system.String name;
}

data Log
{
	system.String user;
	system.String url;
	system.TimeUnix time;

	vector webp.Category categories;
}

data CategoryHits
{
	webp.Category category;
	system.UInt hits;
	system.Double current;
}

data User
{
	system.String id;
	vector webp.CategoryHits category_hits;
	webp.Log last_log;
}

parser parse_web_logs
{
    out system.String webp.Log
	
	help
    {
       "Parse web logs"
	   "Output: [ user Log ]"
    }
}


parser parse_tid_web_logs
{
    out system.String webp.Log
	
	help
    {
       "Parse web logs"
	   "Output: [ user Log ]"
    }
}

map joint_comscore_dictionary
{
	in system.String webp.Log
	out system.String webp.Log

	help
	{
     	"Lookup all url agains the comscore dictionary"
    }
}			

reduce update_user
{
	in  system.String webp.Log
	in  system.String webp.User
	out system.String webp.User

	helpLine "Update profile for this user"
}


script web_profiling
{
    code
    {
        # Input queues
        alias [input]          input;
        alias [input_tid]      input_tid;

		# Internal queues
        alias [logs]           logs;
        alias [errors]         errors;

		# State queues
		alias [users]           users;

        # Operations;
        alias [parse_input]       parse;
        alias [parse_input_tid]   parse_tid;
        alias [update_state]    update;

        # Definitions;
        add_stream_operation   [parse_input]      webp.parse_web_logs      [input]       [logs];
        add_stream_operation   [parse_input_tid]  webp.parse_tid_web_logs  [input_tid]   [logs];
        add_stream_operation   [update_state]     webp.update_user         [logs] [users]    [users];

    }

    helpLine "Init stream operations"
}

script demo
{
    code
    {
        remove_all_stream;
        init_stream webp.web_profiling;
    }

    helpLine "Demo about web profiling"
}